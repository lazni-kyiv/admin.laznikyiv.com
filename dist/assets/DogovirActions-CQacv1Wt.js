import{a as u,f as z,s as $,c as h,o as b,b as t,w as G,C as c,D as g,F as J,g as U,z as L,I as H}from"./index-BHK97qKn.js";import{u as j}from"./AdminView-isQXQewP.js";import{_ as P}from"./_plugin-vue_export-helper-DlAUqK2U.js";const W={class:"form-input"},K={class:"form-input"},Q={class:"form-input"},Y={class:"form-input"},Z={key:0,class:"actions"},_={key:1,class:"actions"},ee={__name:"DogovirActions",props:{guest:{type:Object,required:!0},booking:{type:Object,required:!0}},emits:["update:guest"],setup(x,{emit:B}){const{lockApp:y}=j(),n=u({}),p=u(null),R=u(""),i=x;async function A(o,e=6){const l=new TextEncoder().encode(o),r=await crypto.subtle.digest("SHA-256",l),T=Array.from(new Uint8Array(r)).map(f=>f.toString(16).padStart(2,"0")).join("");let d=BigInt("0x"+T.slice(0,16));const I="01234567890123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",C=BigInt(I.length);let v="";for(;d>0n;){const f=d%C;v=I[Number(f)]+v,d=d/C}return`${v.slice(0,e)}`}async function k(){i.booking.$id&&(R.value=await A(i.booking.$id))}async function X(){const o=`https://dogovir.laznikyiv.com/${JSON.parse(i.booking.dogovir).pdf}.pdf`;window.open(o,"_blank")}function M(){const e=`https://drive.google.com/file/d/${JSON.parse(i.booking.dogovir).link}/view`;window.open(e,"_blank")}const S=B;function w(o){var e,a,l;return{name:((e=o.name)==null?void 0:e.trim())||"",phone:((a=o.phone)==null?void 0:a.replace(/\s+/g,""))||"",birthday:o.birthday||"",document:((l=o.document)==null?void 0:l.trim())||""}}const D=u(null);function m(){const o=w(i.guest);n.value={...o},D.value={...o}}function E(){const o=w(n.value),e=D.value;return o.name!==e.name||o.phone!==e.phone||o.birthday!==e.birthday||o.document!==e.document}z(()=>{m(),k()}),$(()=>i.guest,o=>{o&&m()},{deep:!0}),$(()=>i.booking.$id,()=>{k()});function N(o){let e=o.target.value.replace(/\D/g,"");e.length>=2&&(e=e.slice(0,2)+"."+e.slice(2)),e.length>=5&&(e=e.slice(0,5)+"."+e.slice(5,9)),n.value.birthday=e}function O(o){let e=o.target.value.replace(/\D/g,"");e.startsWith("380")||(e="380"+e),e=e.slice(0,12);let a="+380";e.length>3&&(a+=" "+e.slice(3,5)),e.length>5&&(a+=" "+e.slice(5,8)),e.length>8&&(a+=" "+e.slice(8,12)),n.value.phone=a}async function V(){m(),await H();const o=p.value||document.getElementById("showDogovir");if(o)try{o.showModal()}catch(e){console.error("Error opening modal:",e),o.style.display="block"}else console.error("Modal element not found")}function q(){const o=p.value||document.getElementById("showDogovir");o&&o.close()}async function F(){if(!i.booking||!i.booking.date){console.error("Booking or date is missing",i.booking);return}const[o,e]=i.booking.date.split("-");if(JSON.stringify(n.value),JSON.stringify({name:i.guest.name,phone:i.guest.phone,birthday:i.guest.birthday,document:i.guest.document}),E())try{const s=await U.guests.update(i.guest.$id,{name:n.value.name,phone:n.value.phone,birthday:n.value.birthday,document:n.value.document});n.value={...s.guest},S("update:guest",s.guest)}catch(s){console.error("Failed to update guest:",s);return}const a={family:"Family House",right:"River View Right",left:"River View Left"},l=`/dogovir/${i.booking.$id}?name=${encodeURIComponent(n.value.name)}&birthday=${encodeURIComponent(n.value.birthday)}&phone=${encodeURIComponent(n.value.phone)}&document=${encodeURIComponent(n.value.document)}&in=${encodeURIComponent(o)}&out=${encodeURIComponent(e)}&house=${encodeURIComponent(a[i.booking.house]||"")}`;L.push(l),y();const r=async s=>{s.origin===window.location.origin&&s.data.bookingId===i.booking.$id&&(s.data.type==="dogovir-created"?await U.dogovir.update(i.booking.$id,s.data.dogovirData):s.data.type==="dogovir-cancelled"&&(y(),console.log("Dogovir cancelled by user")),window.removeEventListener("message",r))};window.addEventListener("message",r)}return(o,e)=>(b(),h(J,null,[t("dialog",{id:"showDogovir",ref_key:"dogovirModal",ref:p,class:"modal"},[t("form",{class:"modal-box",onSubmit:G(F,["prevent"])},[e[9]||(e[9]=t("h3",{class:"text-lg font-bold mb-4"},"Договір",-1)),t("div",W,[e[4]||(e[4]=t("label",null,"ПІБ",-1)),c(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=a=>n.value.name=a),placeholder:"ПІБ",required:""},null,512),[[g,n.value.name]])]),t("div",K,[e[5]||(e[5]=t("label",null,"Дата народження",-1)),c(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=a=>n.value.birthday=a),onInput:N,placeholder:"ДД.ММ.РРРР",required:""},null,544),[[g,n.value.birthday]])]),t("div",Q,[e[6]||(e[6]=t("label",null,"Номер телефону",-1)),c(t("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=a=>n.value.phone=a),onInput:O,placeholder:"+380 XX XXX XXXX",required:""},null,544),[[g,n.value.phone]])]),t("div",Y,[e[7]||(e[7]=t("label",null,"Документ",-1)),c(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=a=>n.value.document=a),placeholder:"Паспорт/ID",required:""},null,512),[[g,n.value.document]])]),t("div",{class:"modal-action",style:{"margin-top":"0.5rem"}},[t("button",{class:"secondary",type:"button",onClick:q},"Скасувати"),e[8]||(e[8]=t("button",{type:"submit"},"Відкрити",-1))])],32)],512),i.booking.dogovir?(b(),h("div",_,[t("button",{onClick:X},e[11]||(e[11]=[t("i",{class:"hgi hgi-stroke hgi-pdf-01"},null,-1)])),t("button",{onClick:M},e[12]||(e[12]=[t("i",{class:"hgi hgi-stroke hgi-google-drive"},null,-1)]))])):(b(),h("div",Z,[t("button",{onClick:V},e[10]||(e[10]=[t("i",{class:"hgi hgi-stroke hgi-signature"},null,-1)]))]))],64))}},ie=P(ee,[["__scopeId","data-v-908c15c3"]]);export{ie as D};
